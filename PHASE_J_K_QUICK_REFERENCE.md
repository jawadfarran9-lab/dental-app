# Phase J + K â€” Quick Reference & Screenshots Guide

## ğŸ“± Screen Layouts & Features

### 1. Patient Details â†’ Media Tab

**Path**: `/clinic/[patientId]?tab=media`

**Layout**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Patient Details - [PatientName]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [Timeline] [Media] [Chat]          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [+ Add Image]  [+ New Session]     â”‚  â† Clinic buttons only
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  ğŸ“· Image Grid (2 columns)          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ Image    â”‚  â”‚ Image    â”‚        â”‚
â”‚  â”‚ Jan 15   â”‚  â”‚ Jan 20   â”‚        â”‚
â”‚  â”‚ [DELETE] â”‚  â”‚[DELETE]  â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚  [ANNOTATED]                        â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ Image    â”‚  â”‚ Image    â”‚        â”‚
â”‚  â”‚ Jan 25   â”‚  â”‚ Feb 1    â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Interactions**:
- **Clinic**: Can upload, delete, annotate
- **Patient**: View only (no buttons visible)
- **Tap image**: Opens Full Screen Viewer

---

### 2. Full Screen Image Viewer

**Flow**: Image Grid â†’ Tap image â†’ Viewer opens

**Layout**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Image Viewer                    [X] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                               â”‚  â”‚
â”‚  â”‚  Full Image                   â”‚  â”‚
â”‚  â”‚  (Scrollable, Zoomable)       â”‚  â”‚
â”‚  â”‚                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Date Added: Jan 15, 2025           â”‚
â”‚  Uploaded By: Clinic                â”‚
â”‚  Status: âœ… ANNOTATED               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [Close]          [Annotate] â† clinic only
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Clinic Actions**:
- Tap "Annotate" â†’ Opens Annotation Canvas

**Patient Actions**:
- Tap "Close" only
- No annotation option

---

### 3. Annotation Canvas (Clinic Only)

**Flow**: Full Screen Viewer â†’ [Annotate] â†’ Canvas opens

**Layout**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Annotate Image                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                               â”‚  â”‚
â”‚  â”‚  Original Image (background)  â”‚  â”‚
â”‚  â”‚  [Interactive Drawing Layer]  â”‚  â”‚
â”‚  â”‚                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Color Palette:                      â”‚
â”‚ [ğŸ”´] [ğŸŸ¢] [ğŸ”µ] [ğŸŸ¡] [ğŸŸ£] [ğŸ”µ] [ğŸŸ ] [âšª] [âš«]
â”‚                                     â”‚
â”‚ Brush Size:                         â”‚
â”‚ [2px] [3px] [5px] [8px]             â”‚
â”‚                                     â”‚
â”‚ [Undo] [Clear All]                  â”‚
â”‚                                     â”‚
â”‚ [Cancel]              [Save]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Drawing Features**:
- âœ… Free-form drawing with selected color
- âœ… Multiple brush sizes
- âœ… Undo last stroke
- âœ… Clear all annotations
- âœ… Save exports annotated image

**Storage After Save**:
```
Cloud Storage:
  original: {imageId}.jpg
  annotated: {imageId}_annotated_v1.jpg â† New file

Firestore:
  media/{imageId}:
    hasAnnotation: true
    annotatedUrl: gs://.../{imageId}_annotated_v1.jpg
    
Timeline:
  New entry: "Image Annotated" on [timestamp]
```

---

### 4. Timeline View

**Path**: `/clinic/[patientId]?tab=timeline`

**Layout**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Patient Timeline                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  Latest Events First â†“              â”‚
â”‚                                     â”‚
â”‚  â—† ğŸ“ Image Annotated               â”‚
â”‚  â””â”€ Jan 20, 2025 @ 2:30 PM         â”‚
â”‚     [View Image]                    â”‚
â”‚                                     â”‚
â”‚  â—† ğŸ—‚ï¸  Session: Follow-up           â”‚
â”‚  â””â”€ Jan 18, 2025                   â”‚
â”‚     Visit Details: 2 images        â”‚
â”‚                                     â”‚
â”‚  â—† ğŸ“¸ Image Uploaded                â”‚
â”‚  â””â”€ Jan 15, 2025 @ 10:15 AM        â”‚
â”‚     [View Image]                    â”‚
â”‚                                     â”‚
â”‚  â—† ğŸ—‚ï¸  Session: Initial Consult.    â”‚
â”‚  â””â”€ Jan 10, 2025                   â”‚
â”‚     Visit Details: 3 images        â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Interactions**:
- Click image entry â†’ Full Screen Viewer
- Click session entry â†’ Shows images in that session
- Latest entries appear first
- Clinic & Patient both can view

---

### 5. Create Session Modal (Clinic Only)

**Trigger**: Patient Details â†’ Media tab â†’ [+ New Session]

**Layout**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                     â”‚
â”‚  Create New Session                 â”‚
â”‚                                     â”‚
â”‚  Session Title                      â”‚
â”‚  [________________________]          â”‚
â”‚  e.g., Initial Consultation        â”‚
â”‚                                     â”‚
â”‚  Description (optional)             â”‚
â”‚  [________________________]          â”‚
â”‚  [                      ]           â”‚
â”‚  [                      ]           â”‚
â”‚                                     â”‚
â”‚  [Cancel]          [Create Session] â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Fields**:
- `title` (required) - "Initial Consultation", "Follow-up", etc.
- `description` (optional) - Notes for this visit

**After Create**:
- Session saved to Firestore
- Timeline entry created
- User returns to Media grid

---

## ğŸ”„ Complete Workflow Demo

### Scenario: Clinic Annotations & Patient Views

```
STEP 1: Clinic Login
â””â”€ Dashboard â†’ Patient List â†’ Select Patient

STEP 2: Open Patient Detail
â”œâ”€ Patient profile displayed
â””â”€ Shows [Timeline] [Media] [Chat] tabs

STEP 3: Click Media Tab
â”œâ”€ Shows image grid (empty initially)
â””â”€ Displays [+ Add Image] and [+ New Session] buttons

STEP 4: Upload Image
â”œâ”€ Click [+ Add Image]
â”œâ”€ Modal: Camera / Gallery
â”œâ”€ Select image from gallery
â”œâ”€ Image uploads (progress indicator)
â””â”€ Image appears in grid with date

STEP 5: View Image Details
â”œâ”€ Click on image in grid
â”œâ”€ Full Screen Viewer opens
â”œâ”€ Shows date, metadata
â””â”€ Displays [Close] [Annotate] buttons

STEP 6: Annotate Image
â”œâ”€ Click [Annotate]
â”œâ”€ Annotation Canvas opens with original image
â”œâ”€ Change color (e.g., to red)
â”œâ”€ Adjust brush size (e.g., 5px)
â”œâ”€ Draw on image (circling a tooth, etc.)
â”œâ”€ Change color (e.g., to blue)
â”œâ”€ Add note/label
â””â”€ Click [Save]

STEP 7: Image Saved
â”œâ”€ Annotated image uploaded to Cloud Storage
â”œâ”€ Firestore updated:
â”‚  â”œâ”€ hasAnnotation: true
â”‚  â”œâ”€ annotatedUrl: gs://.../image_annotated_v1.jpg
â”‚  â””â”€ Timeline entry created
â”œâ”€ Canvas closes
â””â”€ Grid now shows [ANNOTATED] badge

STEP 8: Clinic Views Annotated Image
â”œâ”€ Click image again
â”œâ”€ Full Screen Viewer shows annotated version
â”œâ”€ Metadata shows "âœ… ANNOTATED" status
â””â”€ Close viewer

STEP 9: Check Timeline
â”œâ”€ Click Timeline tab
â”œâ”€ Latest entries shown
â”œâ”€ "Image Annotated" entry visible
â”œâ”€ Shows timestamp
â””â”€ Can click to view image again

STEP 10: Patient Logs In
â””â”€ (If patient app has access configured)

STEP 11: Patient Views Media
â”œâ”€ Opens patient app
â”œâ”€ Navigates to clinic messages / media
â”œâ”€ Sees Media tab
â”œâ”€ Clicks image
â””â”€ Full Screen Viewer shows ANNOTATED version only

STEP 12: Patient Views Timeline
â”œâ”€ Timeline tab shows:
â”‚  â”œâ”€ "Image Annotated" entry
â”‚  â”œâ”€ Timestamp of annotation
â”‚  â””â”€ [View] button to open image
â””â”€ No editing/deleting options available
```

---

## ğŸ¯ Key Implementation Files

### Components
| File | Purpose |
|------|---------|
| `ImageUploadButton.tsx` | Camera + Gallery picker |
| `ImageGrid.tsx` | 2-column grid display |
| `FullScreenImageViewer.tsx` | Full image + metadata viewer |
| `AnnotationCanvas.tsx` | Drawing tool with colors/sizes |
| `Timeline.tsx` | Chronological event display |
| `PatientMediaScreen.tsx` | Main media tab container |

### Services
| File | Purpose |
|------|---------|
| `mediaService.ts` | Upload, delete, annotate, sessions, timeline |

### Types
| File | Purpose |
|------|---------|
| `media.ts` | PatientMedia, AnnotationData, PatientSession, TimelineEntry |

### Routes
| Path | Purpose |
|------|---------|
| `/clinic/[patientId]` | Patient details (with media tab) |
| `/clinic/media` | Full media screen (if standalone) |

### Localization
| File | Translations |
|------|--------------|
| `locales/en.json` | English (150+ keys) |
| `locales/ar.json` | Arabic (150+ keys, RTL) |

---

## ğŸ“Š Data Flow Diagram

```
User Action
    â†“
Component (UI Layer)
    â†“
mediaService (Business Logic)
    â†“
Firestore (Data) â† Permissions enforced
    â†“
Cloud Storage (Files)
    â†“
Component Updates
    â†“
User Sees Result
```

### Example: Upload Flow
```
Click [+ Add Image]
    â†“
ImageUploadButton Modal
    â†“
Gallery Picker Returns imageUri
    â†“
uploadPatientImage(patientId, clinicId, imageUri)
    â†“
Fetch â†’ Blob â†’ Cloud Storage Upload
    â†“
Get Download URL
    â†“
Create Firestore Document
    â†“
Create Timeline Entry
    â†“
Return PatientMedia object
    â†“
Update UI: Add to grid, Show in timeline
```

### Example: Annotation Flow
```
Click [Annotate]
    â†“
AnnotationCanvas Opens
    â†“
User Draws + Saves
    â†“
saveAnnotatedImage(patientId, clinicId, mediaId, uri, strokes)
    â†“
Upload Annotated Image to Cloud Storage
    â†“
Save Stroke Data to Firestore
    â†“
Update media document: hasAnnotation=true, annotatedUrl=...
    â†“
Create Timeline Entry: "Image Annotated"
    â†“
Return Updated PatientMedia
    â†“
Canvas Closes, Grid Shows ANNOTATED Badge
```

---

## âœ… Verification Checklist

### Before Going Live

- [ ] All components render without errors
- [ ] Upload works with real images (camera + gallery)
- [ ] Annotation saves and appears in Firestore
- [ ] Patient view shows annotated image (not original)
- [ ] Timeline entries created correctly
- [ ] Sessions can be created and images added
- [ ] Permissions enforced (clinic can edit, patient cannot)
- [ ] Dark mode works correctly
- [ ] Arabic text displays correctly (RTL)
- [ ] Mobile responsiveness verified
- [ ] Network errors handled gracefully

---

## ğŸš€ Deployment

### Current Status
```
âœ… Server: http://localhost:8081
âœ… Metro: Running
âœ… React Compiler: Enabled
âœ… No build errors
âœ… All types correct
âœ… All imports resolved
```

### To Deploy to Production
1. Build APK/IPA: `expo build:android` / `expo build:ios`
2. Deploy to App Store / Play Store
3. Update Firestore rules to production mode
4. Enable Cloud Storage security
5. Set up Firebase backups
6. Configure monitoring & logging

---

## ğŸ“ Testing Instructions

### Test 1: Upload Image
```
1. Login as clinic
2. Open patient detail
3. Click Media tab
4. Tap [+ Add Image]
5. Select gallery
6. Choose image
7. Verify appears in grid
âœ“ Check Firestore: media/{imageId} exists
âœ“ Check Cloud Storage: {imageId}.jpg exists
```

### Test 2: Annotate Image
```
1. From grid, click image
2. Full screen viewer opens
3. Tap [Annotate]
4. Draw red circle
5. Change to blue, add label
6. Tap [Save]
âœ“ Check Cloud Storage: {imageId}_annotated_v1.jpg exists
âœ“ Check Firestore: hasAnnotation=true, annotatedUrl populated
âœ“ Check Timeline: "Image Annotated" entry created
```

### Test 3: Patient View
```
1. Login as patient (or use clinic view)
2. Navigate to patient media
3. See grid (shows annotated version)
4. Click image
5. See full screen viewer (no Annotate button)
âœ“ Verify patient cannot delete/edit
âœ“ Verify patient can see timeline
```

---

## ğŸ“ Learning Resources

### Understanding the Architecture
- **Firestore Structure**: `/app/clinic/[patientId].tsx` - how tabs navigate
- **Component Composition**: `PatientMediaScreen.tsx` - how components work together
- **Service Pattern**: `mediaService.ts` - business logic separation
- **Type Safety**: `src/types/media.ts` - TypeScript usage

### Modifying Features
- **Add new colors**: `AnnotationCanvas.tsx` - `colors_palette` array
- **Change grid columns**: `ImageGrid.tsx` - `numColumns={2}` prop
- **Add new timeline types**: `mediaService.ts` - `createTimelineEntry()` type parameter
- **Custom annotations**: `mediaService.ts` - Extend `AnnotationData` interface

---

**Ready for Testing & Verification** âœ…
